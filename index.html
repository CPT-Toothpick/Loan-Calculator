<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Amortization Calculator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useMemo } = React;

        // Icon components
        const Calculator = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect width="16" height="20" x="4" y="2" rx="2"/>
                <line x1="8" x2="16" y1="6" y2="6"/>
                <line x1="16" x2="16" y1="14" y2="14"/>
                <path d="M16 10h.01"/>
                <path d="M12 10h.01"/>
                <path d="M8 10h.01"/>
                <path d="M12 14h.01"/>
                <path d="M8 14h.01"/>
                <path d="M12 18h.01"/>
                <path d="M8 18h.01"/>
            </svg>
        );

        const Download = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" x2="12" y1="15" y2="3"/>
            </svg>
        );

        const FileSpreadsheet = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/>
                <path d="M14 2v4a2 2 0 0 0 2 2h4"/>
                <path d="M8 13h2"/>
                <path d="M14 13h2"/>
                <path d="M8 17h2"/>
                <path d="M14 17h2"/>
            </svg>
        );

        const LoanAmortization = () => {
          const [loanBalance, setLoanBalance] = useState(31536);
          const [annualRate, setAnnualRate] = useState(3);
          const [monthlyPayment, setMonthlyPayment] = useState(1767.89);

          const schedule = useMemo(() => {
            const monthlyRate = annualRate / 100 / 12;
            let balance = loanBalance;
            const payments = [];
            let month = 1;
            let totalInterest = 0;
            let totalPrincipal = 0;

            while (balance > 0.01 && month <= 60) {
              const interestPayment = balance * monthlyRate;
              const principalPayment = Math.min(monthlyPayment - interestPayment, balance);
              const actualPayment = principalPayment + interestPayment;
              const endingBalance = balance - principalPayment;

              totalInterest += interestPayment;
              totalPrincipal += principalPayment;

              payments.push({
                month,
                beginningBalance: balance,
                payment: actualPayment,
                principal: principalPayment,
                interest: interestPayment,
                endingBalance: Math.max(0, endingBalance)
              });

              balance = endingBalance;
              month++;

              if (balance <= 0) break;
            }

            return { payments, totalInterest, totalPrincipal };
          }, [loanBalance, annualRate, monthlyPayment]);

          const formatCurrency = (value) => {
            return new Intl.NumberFormat('en-US', {
              style: 'currency',
              currency: 'USD',
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            }).format(value);
          };

          const getPayoffDate = (monthsFromNow) => {
            const date = new Date(2026, 0, 1);
            date.setMonth(date.getMonth() + monthsFromNow);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
          };

          const downloadCSV = () => {
            let csv = 'Month,Date,Beginning Balance,Payment,Principal,Interest,Ending Balance\n';
            
            schedule.payments.forEach((payment) => {
              csv += `${payment.month},${getPayoffDate(payment.month - 1)},${payment.beginningBalance.toFixed(2)},${payment.payment.toFixed(2)},${payment.principal.toFixed(2)},${payment.interest.toFixed(2)},${payment.endingBalance.toFixed(2)}\n`;
            });
            
            csv += `\nTotals,,${loanBalance.toFixed(2)},${schedule.payments.reduce((sum, p) => sum + p.payment, 0).toFixed(2)},${schedule.totalPrincipal.toFixed(2)},${schedule.totalInterest.toFixed(2)},0.00\n`;
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'loan_amortization_schedule.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
          };

          const downloadExcel = async () => {
            try {
              // Check if XLSX is already loaded
              if (!window.XLSX) {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                
                await new Promise((resolve, reject) => {
                  script.onload = resolve;
                  script.onerror = reject;
                  document.head.appendChild(script);
                });
              }
              
              const XLSX = window.XLSX;
              const wb = XLSX.utils.book_new();
              
              const inputData = [
                ['Loan Amortization Calculator', ''],
                ['', ''],
                ['Input Parameters', ''],
                ['Starting Loan Balance', loanBalance],
                ['Annual Interest Rate (%)', annualRate],
                ['Monthly Payment (P&I)', monthlyPayment],
                ['Monthly Interest Rate', annualRate/100/12],
                ['', ''],
                ['Summary', ''],
                ['Months to Payoff', schedule.payments.length],
                ['Total Interest Paid', schedule.totalInterest],
                ['Total Principal Paid', schedule.totalPrincipal],
                ['Estimated Payoff Date', getPayoffDate(schedule.payments.length - 1)]
              ];
              
              const scheduleData = [
                ['Month', 'Date', 'Beginning Balance', 'Payment', 'Principal', 'Interest', 'Ending Balance'],
              ];
              
              for (let i = 1; i <= 60; i++) {
                const row = i;
                
                if (i === 1) {
                  scheduleData.push([
                    i,
                    getPayoffDate(i - 1),
                    { f: 'Inputs!B4' },
                    { f: 'Inputs!B6' },
                    { f: `D${row+1}-F${row+1}` },
                    { f: `C${row+1}*Inputs!B7` },
                    { f: `C${row+1}-E${row+1}` }
                  ]);
                } else {
                  scheduleData.push([
                    i,
                    getPayoffDate(i - 1),
                    { f: `IF(G${row},G${row},0)` },
                    { f: `IF(C${row+1}>0,Inputs!B6,0)` },
                    { f: `IF(C${row+1}>0,MIN(D${row+1}-F${row+1},C${row+1}),0)` },
                    { f: `IF(C${row+1}>0,C${row+1}*Inputs!B7,0)` },
                    { f: `IF(C${row+1}>0,MAX(C${row+1}-E${row+1},0),0)` }
                  ]);
                }
              }
              
              scheduleData.push([
                'TOTALS',
                '',
                '',
                { f: 'SUM(D2:D61)' },
                { f: 'SUM(E2:E61)' },
                { f: 'SUM(F2:F61)' },
                ''
              ]);
              
              const wsInputs = XLSX.utils.aoa_to_sheet(inputData);
              const wsSchedule = XLSX.utils.aoa_to_sheet(scheduleData);
              
              wsInputs['!cols'] = [{ wch: 28 }, { wch: 18 }];
              wsSchedule['!cols'] = [
                { wch: 8 }, { wch: 14 }, { wch: 20 }, { wch: 14 },
                { wch: 16 }, { wch: 14 }, { wch: 20 }
              ];
              
              XLSX.utils.book_append_sheet(wb, wsInputs, 'Inputs');
              XLSX.utils.book_append_sheet(wb, wsSchedule, 'Amortization Schedule');
              
              XLSX.writeFile(wb, 'loan_amortization.xlsx');
            } catch (error) {
              console.error('Error creating Excel file:', error);
              alert('Error creating Excel file. Please try the CSV download instead.');
            }
          };

          return (
            <div className="w-full max-w-6xl mx-auto p-6 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg shadow-lg">
              <div className="flex items-center gap-3 mb-6 flex-wrap">
                <Calculator className="w-8 h-8 text-indigo-600" />
                <h1 className="text-3xl font-bold text-gray-800">Loan Amortization Schedule</h1>
                <div className="ml-auto flex gap-2 flex-wrap">
                  <button
                    onClick={downloadExcel}
                    className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors shadow-md"
                  >
                    <FileSpreadsheet className="w-5 h-5" />
                    Download Excel
                  </button>
                  <button
                    onClick={downloadCSV}
                    className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-md"
                  >
                    <Download className="w-5 h-5" />
                    Download CSV
                  </button>
                </div>
              </div>

              <div className="bg-white rounded-lg p-6 mb-6 shadow">
                <h2 className="text-xl font-semibold mb-4 text-gray-700">Loan Parameters</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-600 mb-2">
                      Current Balance ($)
                    </label>
                    <input
                      type="number"
                      value={loanBalance}
                      onChange={(e) => setLoanBalance(parseFloat(e.target.value) || 0)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-600 mb-2">
                      Annual Interest Rate (%)
                    </label>
                    <input
                      type="number"
                      step="0.01"
                      value={annualRate}
                      onChange={(e) => setAnnualRate(parseFloat(e.target.value) || 0)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-600 mb-2">
                      Monthly Payment ($)
                    </label>
                    <input
                      type="number"
                      step="0.01"
                      value={monthlyPayment}
                      onChange={(e) => setMonthlyPayment(parseFloat(e.target.value) || 0)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    />
                  </div>
                </div>
              </div>

              <div className="bg-white rounded-lg p-6 mb-6 shadow">
                <h2 className="text-xl font-semibold mb-4 text-gray-700">Summary</h2>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className="bg-indigo-50 p-4 rounded-lg">
                    <div className="text-sm text-gray-600 mb-1">Months to Payoff</div>
                    <div className="text-2xl font-bold text-indigo-600">{schedule.payments.length}</div>
                  </div>
                  <div className="bg-green-50 p-4 rounded-lg">
                    <div className="text-sm text-gray-600 mb-1">Total Interest</div>
                    <div className="text-2xl font-bold text-green-600">{formatCurrency(schedule.totalInterest)}</div>
                  </div>
                  <div className="bg-blue-50 p-4 rounded-lg">
                    <div className="text-sm text-gray-600 mb-1">Total Principal</div>
                    <div className="text-2xl font-bold text-blue-600">{formatCurrency(schedule.totalPrincipal)}</div>
                  </div>
                  <div className="bg-purple-50 p-4 rounded-lg">
                    <div className="text-sm text-gray-600 mb-1">Payoff Date</div>
                    <div className="text-2xl font-bold text-purple-600">{getPayoffDate(schedule.payments.length - 1)}</div>
                  </div>
                </div>
              </div>

              <div className="bg-white rounded-lg shadow overflow-hidden">
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-indigo-600 text-white">
                      <tr>
                        <th className="px-4 py-3 text-left text-sm font-semibold">Month</th>
                        <th className="px-4 py-3 text-left text-sm font-semibold">Date</th>
                        <th className="px-4 py-3 text-right text-sm font-semibold">Beginning Balance</th>
                        <th className="px-4 py-3 text-right text-sm font-semibold">Payment</th>
                        <th className="px-4 py-3 text-right text-sm font-semibold">Principal</th>
                        <th className="px-4 py-3 text-right text-sm font-semibold">Interest</th>
                        <th className="px-4 py-3 text-right text-sm font-semibold">Ending Balance</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                      {schedule.payments.map((payment, index) => (
                        <tr key={index} className={index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}>
                          <td className="px-4 py-3 text-sm text-gray-900">{payment.month}</td>
                          <td className="px-4 py-3 text-sm text-gray-600">{getPayoffDate(payment.month - 1)}</td>
                          <td className="px-4 py-3 text-sm text-right text-gray-900">{formatCurrency(payment.beginningBalance)}</td>
                          <td className="px-4 py-3 text-sm text-right font-medium text-gray-900">{formatCurrency(payment.payment)}</td>
                          <td className="px-4 py-3 text-sm text-right text-blue-600">{formatCurrency(payment.principal)}</td>
                          <td className="px-4 py-3 text-sm text-right text-red-600">{formatCurrency(payment.interest)}</td>
                          <td className="px-4 py-3 text-sm text-right font-medium text-gray-900">{formatCurrency(payment.endingBalance)}</td>
                        </tr>
                      ))}
                    </tbody>
                    <tfoot className="bg-gray-100 font-semibold">
                      <tr>
                        <td colSpan="3" className="px-4 py-3 text-sm text-gray-900">Totals</td>
                        <td className="px-4 py-3 text-sm text-right text-gray-900">{formatCurrency(schedule.payments.reduce((sum, p) => sum + p.payment, 0))}</td>
                        <td className="px-4 py-3 text-sm text-right text-blue-600">{formatCurrency(schedule.totalPrincipal)}</td>
                        <td className="px-4 py-3 text-sm text-right text-red-600">{formatCurrency(schedule.totalInterest)}</td>
                        <td className="px-4 py-3 text-sm text-right text-gray-900">$0.00</td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LoanAmortization />);
    </script>
</body>
</html>
